---
title: "Biostat 625 Final Project - Post 9/11 Flight Delay"
author: "Ralph Jiang, Xuelin Gu, Allen Li"
date: "December 18, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dbplyr)
library(data.table)
library(dplyr)
library(readr)
library(bigmemory)
library(biganalytics) 
```

## Introduction

Wanted to investigate and predict and investigate trends in flight delay


## Methods

### Data Processing and Storage
(add in what you did ralph to merge the weather data)

biostat cluster using unix script - pre-prep and combining the separate data years
(cp in code a bit later), but rbind in the cluster worked, merging the datafiles together 
to 

read separate files in the dataset folder and conbine their rows 
```{r}
##read separate files in the dataset folder and conbine their rows 
dataFiles = list.files(pattern = "*.csv") %>% 
  lapply(read.csv, stringsAsFactors=F) %>% 
  bind_rows 
write.csv(dataFiles,file='out.csv')
```

Data cleaning and preprocessing

There are 72 variables in the table. 
Firstly, we deleted the cancelled and diverted flights which may have different situation with other common delayed flights. Secondly,to make the analysis more efficiently, we deleted some of the variables not included in the following analysis and make the table smaller for several reasons: 1 providing little information or providing information contained in other variables; 2 not included in this project objectives; 3 high ratio missing data. Third, we add covariate "season" based on "Month" value.
```{r}
list_file = data.table::fread("out.csv")

dat = filter(list_file, Cancelled==0&Diverted==0)
dat = subset(dat, -c(V1))

dat = select(dat,-c(key2, key, DepTime, `STN---.x`, YEARMODA.x, `STN---.y`, YEARMODA.y,     #reason 1
                    CRSDepTime, ArrTime, CRSArrTime, ActualElapsedTime, CRSElapsedTime, #reason 1
                    Cancelled, CancellationCode, Diverted, #reason 2
                  CarrierDelay, WeatherDelay, NASDelay, SecurityDelay, LateAircraftDelay, STP.x, STP.y, GUST.x, GUST.y)) ##reason 3
#create season covariate
dat = mutate(dat, season = NA)
dat[which(dat$Month==1|dat$Month==2|dat$Month==3),]$season="winter"
dat[which(dat$Month==4|dat$Month==5|dat$Month==6),]$season="spring"
dat[which(dat$Month==7|dat$Month==8|dat$Month==9),]$season="summer"
dat[which(dat$Month==10|dat$Month==10|dat$Month==11),]$season="fall"
##
```

Descriptive statistics of variables.
```{r}
##character variables:UniqueCarrier, FlightNum, TailNum, Origin, Dest, Fog.x, Rain.x, Snow.x, Hail.x, Thunder.x, Tornado.x,
                    #Fog.y, Rain.y, Snow.y, Hail.y, Thunder.y, Tornado.y,season.
##numeric variables:Year, Month, DayofMonth, DayOfWeek, Distance, TaxiIn, TaxiOut, TEMP.x, DEWP.x, SLP.x, VISIB.x,
                   #WDSP.x, MXSPD.x, MAX.x, MIN.x, PRCP.x, SNDP.x, TEMP.y, DEWP.y, SLP.y, VISIB.y,
                   #WDSP.y, MXSPD.y, MAX.y, MIN.y, PRCP.y, SNDP.y
##obtain descriptive statistic for numeric covaraites
select(dat, c(Year, Month, DayofMonth, DayOfWeek, Distance, TaxiIn, TaxiOut, TEMP.x, DEWP.x, SLP.x, VISIB.x,
              WDSP.x, MXSPD.x, MAX.x, MIN.x, PRCP.x, SNDP.x, TEMP.y, DEWP.y, SLP.y, VISIB.y,
              WDSP.y, MXSPD.y, MAX.y, MIN.y, PRCP.y, SNDP.y)) %>% summary()
select(dat, c(Year, Month, DayofMonth, DayOfWeek, Distance, TaxiIn, TaxiOut, TEMP.x, DEWP.x, SLP.x, VISIB.x,
              WDSP.x, MXSPD.x, MAX.x, MIN.x, PRCP.x, SNDP.x, TEMP.y, DEWP.y, SLP.y, VISIB.y,
              WDSP.y, MXSPD.y, MAX.y, MIN.y, PRCP.y, SNDP.y)) %>% var()
##obtain frequency tables for categorical covaraites
select(dat, UniqueCarrier) %>% table()
select(dat, FlightNum) %>% table() ## too many categories
select(dat, TailNum) %>% table() ## too many categories
select(dat, Origin) %>% table()
select(dat, Dest) %>% table()
select(dat, Fog.x) %>% table()
select(dat, Rain.x) %>% table()
select(dat, Snow.x) %>% table()
select(dat, Hail.x) %>% table()
select(dat, Thunder.x) %>% table()
select(dat, Tornado.x) %>% table()
select(dat, Fog.y) %>% table()
select(dat, Rain.y) %>% table()
select(dat, Snow.y) %>% table()
select(dat, Hail.y) %>% table()
select(dat, Thunder.y) %>% table()
select(dat, Tornado.y) %>% table()
select(dat, season) %>% table()
##obtain correlation coefficients of numeric covariates using complete data
select(dat, c(Year, Month, DayofMonth, DayOfWeek, Distance, TaxiIn, TaxiOut, TEMP.x, DEWP.x, SLP.x, VISIB.x,
              WDSP.x, MXSPD.x, MAX.x, MIN.x, PRCP.x, SNDP.x, TEMP.y, DEWP.y, SLP.y, VISIB.y,
              WDSP.y, MXSPD.y, MAX.y, MIN.y, PRCP.y, SNDP.y)) %>% cor(,use = "complete.obs")
##There is no highly correlations between pairwise covariates, except for MIN.x, MAX.x, MIN.y, MAX.y.
```

Linear regression based on descriptive result
```{r}
dat$UniqueCarrier = as.factor(dat$UniqueCarrier)
dat$Origin = as.factor(dat$Origin)
dat$Dest = as.factor(dat$Dest)
dat$season = as.factor(dat$season)
lr_result = biglm.big.matrix (DepDelay ~ Year + Month + DayofMonth + DayOfWeek + Distance + TaxiIn + TaxiOut + TEMP.x +
                                DEWP.x + SLP.x + VISIB.x + WDSP.x + MXSPD.x + PRCP.x + SNDP.x + TEMP.y + DEWP.y + 
                                SLP.y + VISIB.y + WDSP.y + MXSPD.y + PRCP.y + SNDP.y + UniqueCarrier + Origin + Dest + 
                                Fog.x + Rain.x + Snow.x + Hail.x + Thunder.x + Tornado.x + Fog.y + Rain.y + Snow.y + 
                                Hail.y + Thunder.y + Tornado.y + season, data = dat )
```

bigmemory package (simplified to all number type columns, no need to use ff)  


### Analytics

biganalytics package
lme4

Use a linear regression on Delay ~ Weather Age Year
Linear miexed model on Delay ~ Weather Age + random Year

### Visualization
tidyverse family


## Results  

adljaf
(include figures and whatnot)


## Conclusion and Further Work

Pre- 9/11 era and comparison
